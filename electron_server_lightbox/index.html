<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <title>9 FOR 9 LIGHTBOX</title>
  <link rel="stylesheet" href="css/main.css" />
  <link rel="stylesheet" href="css/materialize.min.css" />
  <script src="js/materialize.min.js"></script>
  <script src="./js/lightbox_helpers.js"></script>
  <script src="js/screen_escape.js"></script>
  <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
  <meta http-equiv="Content-Security-Policy" content="script-src 'self' 'unsafe-inline';" />
</head>

<body>
  <nav class="red darken-4">
    <div class="nav-wrapper">
      <img src="images/9_For_9_Logo.png" class="logo"></img>
      <a class="brand-logo center">9 For 9 LightBox</a>
    </div>
  </nav>
  <div class="container1">
    <span id="judge1" class="dot"></span>
    <span id="judge2" class="dot"></span>
    <span id="judge3" class="dot"></span>
  </div>
  <div class='row'>
    <h4 id='result_text' class='col s12 center hidden'>test</h4>
  </div>
  <div>
    <h2 id='timer' class="col s12 center">60s</h2>
  </div>
  <script>
    var lbh = require('./js/lightbox_helpers.js')

    lbh.timer("60", document.getElementById('timer'));
    
    var RESULTS = {'judge1': -1, 'judge2': -1, 'judge3': -1}
    var sent_commands = { 'judge1': false, 'judge2': false, 'judge3': false }
    const ipcRenderer = require('electron').ipcRenderer;
    const socket = new WebSocket("ws://localhost:1080");
    ipcRenderer.on('incoming_data', function (event, incoming_data) {
      dic = JSON.parse(incoming_data);
      sent_commands['judge' + dic.judge_id] = true;
      // turn the light a darker color
      document.getElementById('judge' + dic.judge_id).style.backgroundColor = '#9c9199';
      if (dic.is_good_from_judge) {
        RESULTS['judge' + dic.judge_id] = 1
      } else {
        RESULTS['judge' + dic.judge_id] = 0
      }
      // check if all judges have sent their lights
      if (sent_commands['judge1'] && sent_commands['judge2'] && sent_commands['judge3']) {
        socket.send('disable_btns')
        for(const [key, value] of Object.entries(RESULTS)){
          if(value === 1){
            document.getElementById(key).style.backgroundColor = 'white';
          }
          else{
            document.getElementById(key).style.backgroundColor = 'red';
          }
        }
        // Display Result
        result = lbh.determine_lift_status(RESULTS)
        lbh.sleep(8000).then(() => {
          socket.send('enable_btns')
          document.getElementById('judge1').style.backgroundColor = '#919191';
          document.getElementById('judge2').style.backgroundColor = '#919191';
          document.getElementById('judge3').style.backgroundColor = '#919191';
          for (let x in sent_commands) {
            sent_commands[x] = false
            RESULTS[x] = -1
          }
          document.getElementById('result_text').classList.add('hidden')
        });
      }
    });
  </script>
</body>

</html>